@startuml POS系统数据库E-R图

!theme plain
skinparam backgroundColor #FFFFFF
skinparam entity {
    BackgroundColor #E1F5FE
    BorderColor #0277BD
    FontSize 10
}
skinparam relationship {
    FontSize 8
}

title POS系统数据库E-R图 (Monty风格设计)

' 租户与用户管理模块
package "租户与用户管理" {
    entity "Store (店铺)" as Store {
        * store_id (PK) : BIGINT
        --
        store_name : VARCHAR(100)
        address : TEXT
        phone : VARCHAR(20)
        tax_rate : DECIMAL(5,4)
        currency : VARCHAR(3)
        timezone : VARCHAR(50)
        business_hours : JSON
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_active : BOOLEAN
        is_deleted : BOOLEAN
    }

    entity "User (用户/员工)" as User {
        * user_id (PK) : BIGINT
        * store_id (FK) : BIGINT
        --
        email : VARCHAR(100)
        password_hash : VARCHAR(255)
        pin_hash : VARCHAR(255)
        first_name : VARCHAR(50)
        last_name : VARCHAR(50)
        status : ENUM
        salary : DECIMAL(10,2)
        hire_date : DATE
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        last_login_at : TIMESTAMP
        is_deleted : BOOLEAN
    }

    entity "Role (角色)" as Role {
        * role_id (PK) : BIGINT
        --
        role_name : VARCHAR(50)
        role_code : VARCHAR(50)
        description : TEXT
        is_active : BOOLEAN
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }

    entity "Permission (权限)" as Permission {
        * permission_id (PK) : BIGINT
        --
        permission_name : VARCHAR(100)
        permission_code : VARCHAR(50)
        resource : VARCHAR(50)
        action : VARCHAR(50)
        description : TEXT
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }

    entity "UserRole (用户角色关联)" as UserRole {
        * user_id (FK) : BIGINT
        * role_id (FK) : BIGINT
        --
        assigned_at : TIMESTAMP
        assigned_by : BIGINT
        is_active : BOOLEAN
    }

    entity "RolePermission (角色权限关联)" as RolePermission {
        * role_id (FK) : BIGINT
        * permission_id (FK) : BIGINT
        --
        granted_at : TIMESTAMP
        granted_by : BIGINT
    }
}

' 商品与库存管理模块
package "商品与库存管理" {
    entity "Category (商品分类)" as Category {
        * category_id (PK) : BIGINT
        * store_id (FK) : BIGINT
        --
        category_name : VARCHAR(100)
        description : TEXT
        display_order : INT
        is_active : BOOLEAN
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }

    entity "Product (商品)" as Product {
        * product_id (PK) : BIGINT
        * store_id (FK) : BIGINT
        * category_id (FK) : BIGINT
        --
        product_name : VARCHAR(200)
        description : TEXT
        price : DECIMAL(10,2)
        image_url : VARCHAR(500)
        is_active : BOOLEAN
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }

    entity "Inventory (库存)" as Inventory {
        * inventory_id (PK) : BIGINT
        * product_id (FK) : BIGINT
        --
        current_stock : INT
        min_stock : INT
        max_stock : INT
        cost_price : DECIMAL(10,2)
        last_updated : TIMESTAMP
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }
}

' 考勤与会话管理模块
package "考勤与会话管理" {
    entity "Attendance (考勤)" as Attendance {
        * attendance_id (PK) : BIGINT
        * user_id (FK) : BIGINT
        * store_id (FK) : BIGINT
        --
        clock_in_time : TIMESTAMP
        clock_out_time : TIMESTAMP
        total_hours : DECIMAL(5,2)
        idempotency_key : VARCHAR(100)
        sync_status : ENUM
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }

    entity "UserSession (用户会话)" as UserSession {
        * session_id (PK) : BIGINT
        * user_id (FK) : BIGINT
        device_id (FK) : BIGINT
        --
        token_hash : VARCHAR(255)
        expires_at : TIMESTAMP
        is_active : BOOLEAN
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        last_activity : TIMESTAMP
    }

    entity "Closing (交班记录)" as Closing {
        * closing_id (PK) : BIGINT
        * user_id (FK) : BIGINT
        * store_id (FK) : BIGINT
        --
        closing_date : DATE
        cash_counted : DECIMAL(10,2)
        cash_expected : DECIMAL(10,2)
        difference : DECIMAL(10,2)
        sync_status : ENUM
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }

    entity "Receipt (收据记录)" as Receipt {
        * receipt_id (PK) : BIGINT
        * order_id (FK) : BIGINT
        --
        delivery_method : ENUM
        recipient : VARCHAR(200)
        sent_at : TIMESTAMP
        status : ENUM
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }
}

' 订单与支付管理模块
package "订单与支付管理" {
    entity "Customer (客户)" as Customer {
        * customer_id (PK) : BIGINT
        * store_id (FK) : BIGINT
        --
        customer_name : VARCHAR(100)
        phone : VARCHAR(20)
        email : VARCHAR(100)
        points_balance : INT
        membership_level : VARCHAR(20)
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }

    entity "Order (订单)" as Order {
        * order_id (PK) : BIGINT
        * store_id (FK) : BIGINT
        customer_id (FK) : BIGINT
        * user_id (FK) : BIGINT
        --
        order_number : VARCHAR(50)
        idempotency_key : VARCHAR(100)
        total_amount : DECIMAL(10,2)
        tax_amount : DECIMAL(10,2)
        tip_amount : DECIMAL(10,2)
        discount_amount : DECIMAL(10,2)
        payment_status : ENUM
        order_status : ENUM
        order_type : ENUM
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        completed_at : TIMESTAMP
        is_deleted : BOOLEAN
    }

    entity "OrderItem (订单项)" as OrderItem {
        * order_item_id (PK) : BIGINT
        * order_id (FK) : BIGINT
        * product_id (FK) : BIGINT
        --
        quantity : INT
        unit_price : DECIMAL(10,2)
        subtotal : DECIMAL(10,2)
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }

    entity "Payment (支付)" as Payment {
        * payment_id (PK) : BIGINT
        * order_id (FK) : BIGINT
        --
        idempotency_key : VARCHAR(100)
        payment_method : VARCHAR(50)
        amount : DECIMAL(10,2)
        transaction_id : VARCHAR(100)
        status : ENUM
        processed_at : TIMESTAMP
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }

    entity "Coupon (优惠券)" as Coupon {
        * coupon_id (PK) : BIGINT
        * store_id (FK) : BIGINT
        --
        coupon_code : VARCHAR(50)
        discount_type : ENUM
        discount_value : DECIMAL(10,2)
        min_order_amount : DECIMAL(10,2)
        valid_from : TIMESTAMP
        valid_until : TIMESTAMP
        usage_limit : INT
        used_count : INT
        is_active : BOOLEAN
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
        created_by : BIGINT
        updated_by : BIGINT
        is_deleted : BOOLEAN
    }

    entity "OrderCoupon (订单优惠券关联)" as OrderCoupon {
        * order_id (FK) : BIGINT
        * coupon_id (FK) : BIGINT
        --
        discount_applied : DECIMAL(10,2)
        created_at : TIMESTAMP
        created_by : BIGINT
    }
}

' 系统管理与配置模块
package "系统管理与配置" {
    entity "Device (设备)" as Device {
        * device_id (PK) : BIGINT
        * store_id (FK) : BIGINT
        --
        device_name : VARCHAR(100)
        device_type : VARCHAR(50)
        mac_address : VARCHAR(17)
        ip_address : VARCHAR(15)
        last_online : TIMESTAMP
        status : ENUM
        registered_at : TIMESTAMP
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
    }

    entity "TaxRule (税务规则)" as TaxRule {
        * tax_rule_id (PK) : BIGINT
        * store_id (FK) : BIGINT
        --
        tax_name : VARCHAR(100)
        tax_rate : DECIMAL(5,4)
        tax_type : ENUM
        applicable_to : VARCHAR(100)
        effective_from : DATE
        effective_until : DATE
        is_active : BOOLEAN
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
    }

    entity "Notification (通知)" as Notification {
        * notification_id (PK) : BIGINT
        store_id (FK) : BIGINT
        user_id (FK) : BIGINT
        --
        title : VARCHAR(200)
        message : TEXT
        type : VARCHAR(50)
        is_read : BOOLEAN
        created_at : TIMESTAMP
        read_at : TIMESTAMP
    }
}

' 报表与汇总模块
package "报表与汇总" {
    entity "DailySalesReport (日销售汇总)" as DailySalesReport {
        * report_id (PK) : BIGINT
        * store_id (FK) : BIGINT
        --
        report_date : DATE
        total_sales_amount : DECIMAL(12,2)
        total_orders : INT
        average_order_value : DECIMAL(10,2)
        total_tips : DECIMAL(10,2)
        top_product_id : BIGINT
        created_at : TIMESTAMP
        updated_at : TIMESTAMP
    }
}

' 关系定义
Store ||--o{ User : "1:N"
Store ||--o{ Category : "1:N"
Store ||--o{ Product : "1:N"
Store ||--o{ Customer : "1:N"
Store ||--o{ Order : "1:N"
Store ||--o{ Coupon : "1:N"
Store ||--o{ Device : "1:N"
Store ||--o{ TaxRule : "1:N"
Store ||--o{ Notification : "1:N"
Store ||--o{ DailySalesReport : "1:N"
Store ||--o{ Attendance : "1:N"
Store ||--o{ Closing : "1:N"

User }o--o{ Role : "N:M (through UserRole)"
User ||--o{ UserRole : "1:N"
Role ||--o{ UserRole : "1:N"
Role }o--o{ Permission : "N:M (through RolePermission)"
Role ||--o{ RolePermission : "1:N"
Permission ||--o{ RolePermission : "1:N"
User ||--o{ Order : "1:N"
User ||--o{ Notification : "1:N"
User ||--o{ Attendance : "1:N"
User ||--o{ UserSession : "1:N"
User ||--o{ Closing : "1:N"

Category ||--o{ Product : "1:N"
Product ||--|| Inventory : "1:1"
Product ||--o{ OrderItem : "1:N"

Customer ||--o{ Order : "1:N"
Order ||--o{ OrderItem : "1:N"
Order ||--o{ Payment : "1:N"
Order }o--o{ Coupon : "N:M (through OrderCoupon)"
Order ||--o{ OrderCoupon : "1:N"
Coupon ||--o{ OrderCoupon : "1:N"
Order ||--o{ Receipt : "1:N"

Device ||--o{ UserSession : "1:N"

@enduml
